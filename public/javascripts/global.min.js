function populateTable(){var a="";$.getJSON("/userlist",function(b){userListData=b,clearMarkers(),$.each(b,function(){if(a+="<tr>",a+='<td><a href="#" class="linkshowuser" rel="'+this.username+'">'+this.displayname+"</a></td>",a+="<td>"+this.email+"</td>",a+="</tr>",document.getElementById("googleMap")&&this.lat&&this.lng){var b=new google.maps.Marker({map:map,position:{lat:this.lat,lng:this.lng}});mapMarkers.push(b)}}),$("#userList table tbody").html(a),$("#user").hide(),$("#photoemail").hide(),$("#changeusername").hide(),$("#Commentswrapper").hide(),$("#userInfo").hide(),$("#userList").show(),$("#editPage").hide(),$("#buttons").hide(),$("#searchwrapper").hide(),$("#searchform").show(),$("#wrapper1").show(),$("#wrapper2").show();var c=$("#user").text(),d=userListData.map(function(a){return a.displayname}).indexOf(c);user=userListData[d],user&&(user.dogowner?$("#requestDogLover").show():$("#requestDogLover").hide())})}function showSearch(a){var b,c,d=$.Deferred(),e="",f=document.getElementById("searchfield").value,g=document.getElementById("searchterm").value;"location"==f?searchgeocoder.geocode({address:$("#searchterm").val()},function(e,f){if(f!=google.maps.GeocoderStatus.OK)return registErrors.text("Invalid Address"),void registErrors.show();var g=e[0].geometry.location;$(a).prepend('<input type="hidden" id="lat" name="lat" value="'+g.lat()+'">'),$(a).prepend('<input type="hidden" id="lng" name="lng" value="'+g.lng()+'">'),b=document.getElementById("lat").value,c=document.getElementById("lng").value,d.resolve()}):d.resolve(),$.when(d).done(function(){console.log("searchfield: "+f),console.log("searchterm: "+g),console.log("lat: "+b),console.log("lng: "+c);var a="";a="location"==f?"/searchlocation?&lng="+c+"&lat="+b:"/searchresults?searchterm="+g+"&searchfield="+f,console.log(a),$.getJSON(a,function(a){console.log("datahits0"+a.hits[0]),null!=a.hits[0]?($("#searchhits").show(),$("#searchnohits").hide(),clearMarkers(),$.each(a.hits,function(){if(e+="<tr>",e+='<td><a href="#" class="linkshowuser" rel="'+this.document.username+'">'+this.document.displayname+"</a></td>",e+="<td>"+this.document.email+"</td>",e+="</tr>",document.getElementById("googleMap")){var a=new google.maps.Marker({map:map,position:{lat:this.document.lat,lng:this.document.lng}});mapMarkers.push(a)}}),$("#searchwrapper table tbody").html(e)):(console.log("no hits"),$("#searchhits").hide(),$("#searchnohits").show(),$("#searchnohits h4").html("Sorry, We could not find any matches for your search")),$("#user").hide(),$("#photoemail").hide(),$("#changeusername").hide(),$("#Commentswrapper").hide(),$("#userInfo").hide(),$("#userList").hide(),$("#editPage").hide(),$("#requestDogLover").hide(),$("#wrapper1").hide(),$("#searchwrapper").show(),$("#wrapper2").hide()})})}function showUserInfo(a){$.ajax({type:"POST",url:"/clickeduser/"+$(this).attr("rel")}).done(function(a){$.getJSON("/clickeduser",function(a){var b=a.username,c=userListData.map(function(a){return a.username}).indexOf(b);thisUserObject=userListData[c],$("#wrapper1").hide(),$("#wrapper2").hide(),$("#userInfo").show(),$("#Commentswrapper").show(),$("#userList").hide(),$("#editPage").hide(),$("#buttons").hide(),$("#revokeadmin").hide(),$("#makeadmin").hide(),$("#deleteuser").hide(),$("#edit").hide(),$("#adminOnly").hide(),$("#searchwrapper").hide(),$("#commentemail").val(thisUserObject.email),$("#authoremail").val(user.email);var d="<div>Available Requests</div>",e="<div>Accepted Requests</div>";$.each(thisUserObject.requests,function(){""==this.acceptedby?(d+='<div class="eachrequest">',d+="<div>Start Time "+this.starttime.split("T")[0]+" "+this.starttime.split("T")[1]+"</div>",d+="<div>End Time "+this.endtime.split("T")[0]+" "+this.endtime.split("T")[1]+"</div>",d+='<button class="btn btn-success btn-sm pull-right" onclick="acceptRequest(\''+this._id+"')\">accept</button>",d+='<div class="row spacer"></div>',d+='<hr class="reg-header-hr"/>',d+="</div>"):(e+='<div class="eachrequest">',e+="<div>Start Time "+this.starttime.split("T")[0]+" "+this.starttime.split("T")[1]+"</div>",e+="<div>End Time "+this.endtime.split("T")[0]+" "+this.endtime.split("T")[1]+"</div>",e+="<div>Accepted By: "+this.acceptedby+"</div>",e+="</div>",e+='<hr class="reg-header-hr"/>')}),$("#Requestslist").html(d+e);var f="";$.each(thisUserObject.ratings,function(){f+='<div class="eachcomment">',f+='<div class="panel panel-default">',f+='<div class="panel-heading">'+this.author+"</div>",f+='<div class="panel-body"><p><b>Rating:</b> '+this.rate+"</p> </br><p><b>Comment: </b>"+this.comment+"</p></div>",f+="</div>",f+="</div>"}),$("#Commentslist").html(f),user.superadmin?($("#adminOnly").show(),thisUserObject.admin?$("#revokeadmin").show():$("#makeadmin").show(),$("#deleteuser").show(),$("#edit").show(),$("#editbutton").show()):user.admin?($("#adminOnly").show(),thisUserObject.admin?user._id==thisUserObject._id&&($("#editbutton").show(),$("#edit").show()):($("#deleteuser").show(),$("#edit").show(),$("#editbutton").show())):user.username==thisUserObject.username?($("#edit").show(),$("#buttons").hide(),$("#editbutton").show()):$("#editbutton").hide(),$("#userDisplayName").text(thisUserObject.displayname),$("#userDisplayNameComment").text(thisUserObject.displayname),$("#userEmail").text(thisUserObject.email),$("#userDescription").text(thisUserObject.description),$("#pageViews").text(thisUserObject.pageviews),$("#ipAddress").text(thisUserObject.ipaddr),$("#location").text(thisUserObject.location),$("#viewingDevice").text(thisUserObject.device),thisUserObject.profilepicture&&$("#profilepicture").attr("src","/file/"+thisUserObject.profilepicture),$.ajax({type:"POST",url:"/increasepagecount/"+thisUserObject._id+"/"+thisUserObject.pageviews})})})}function deleteUser(){var a=confirm("Are you sure you want to delete this user?");return a!==!0?!1:void $.ajax({type:"DELETE",url:"/deleteuser/"+thisUserObject._id}).done(function(a){""===a.msg||alert("Error: "+a.msg),window.location.href="/"})}function goHome(a){$("#searchwrapper").hide(),$("#userInfo").hide(),$("#userList").show(),$("#editPage").hide(),populateTable(),window.location.href="/"}function login(a){window.location.href="/login"}function logout(a){window.location.href="/logout"}function register(a){window.location.href="/register"}function editUser(){$("#wrapper1").hide(),$("#wrapper2").hide(),$("#searchwrapper").hide(),$("#userInfo").hide(),$("#userList").hide(),$("#editPage").show(),$("#email").val(thisUserObject.email),$("#photoemail").val(thisUserObject.email),$("#username").val(thisUserObject.email),$("#changeusername").val(thisUserObject.email),$("#displayname").val(thisUserObject.displayname),$("#description").val(thisUserObject.description),thisUserObject.profilepicture&&$("#profilepicturesection").attr("src","/file/"+thisUserObject.profilepicture)}function changeAdmin(a){$.ajax({type:"POST",url:"/makeadmin/"+thisUserObject._id+"/"+a}).done(function(a){window.location.href="/"})}function acceptRequest(a){$.ajax({type:"POST",url:"/acceptrequest/"+thisUserObject.email+"/"+a}).done(function(a){window.location.href="/"})}function changePicture(){$.getJSON("/userclicked",function(a){userClicked=a})}function registerformvalidate(a){var b=$("#registErrors");b.hide();var c=$("#password");if(""==c.val()||""==$("#confirmpassword").val()||""==$("#username").val()||!$("#location").val())return b.text("One or more fields are blank"),void b.show();var d=/\d/,e=/[A-Z]/,f=/[a-z]/,g=/[@]/;return c.val().length<8?(b.text("Your password must be at least 8 characters long."),void b.show()):g.test($("#username").val())?c.val().indexOf($("#username").val())>-1?(b.text("Your password may not contain your username to better secure your account."),void b.show()):d.test(c.val())?e.test(c.val())?f.test(c.val())?$("#location").val()?void geocoder.geocode({address:$("#location").val()},function(c,d){if(d!=google.maps.GeocoderStatus.OK)return b.text("Invalid Address"),void b.show();var e=c[0].geometry.location;$(a).prepend('<input type="hidden" name="lat" value="'+e.lat()+'">'),$(a).prepend('<input type="hidden" name="lng" value="'+e.lng()+'">'),a.submit()}):(b.text("Please enter your location."),void b.show()):(b.text("Your password must contain at least one lowercase letter."),void b.show()):(b.text("Your password must contain at least one capital letter."),void b.show()):(b.text("Your password must contain at least one number."),void b.show()):(b.text("Not a valid email. Must have @"),void b.show())}function loginformvalidate(a){var b=/@/;return""==$("#username").val()||""==$("#password").val()?void alert("One or more fields are blank"):b.test($("#username").val())?void 0:void alert("not a valid email")}function facebookLogin(){window.location.href="/login/facebook"}var userListData=[],user,thisUserObject,mapMarkers=[];$(document).ready(function(){populateTable(),$("#userList table tbody").on("click","td a.linkshowuser",showUserInfo),$("#searchhits table tbody").on("click","td a.linkshowuser",showUserInfo),$("#searchform").validate({submitHandler:showSearch}),$("#upload").on("click","filename",changePicture),$("#register").validate({submitHandler:registerformvalidate}),$("#loginsubmit").validate({submitHandler:loginformvalidate})});var clearMarkers=function(){for(var a=0;a<mapMarkers.length;a++)mapMarkers[a].setMap(null)};